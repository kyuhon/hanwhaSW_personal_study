report 정리

신고생성

신고에 있는 suspensionCycle컬럼에 회원테이블의 정지횟수를 넣는다
	suspensionCycle의 컬럼 존재 이유
		신고테이블에 저장되는 인스턴스가 hard delete가 아닌 soft delete를 적용해서 이전 기록과 구분하기 위해
		회원의 정지 기준에서 이전 인스턴스의 갯수를 제외하고 새로 생성된 갯수를 확인하기 위해서

신고에 대한 예외처리
회원테이블에서 상태가 정지이거나 블랙리스트이면 예외처리 1,2
해당 게시판의 게시글이 존재하지 않으면 예외처리 4
해당 게시판의 작성 아이디와 신고대상 아이디가 일치하지 않으면 예외처리 5
해당 신고가 신고되었거나 신고가 승인되지 않지 않은 것에 대한 예외처리 9

	예외처리 설정추가
		config 패키지에 예외처리만 담당하는 클래스파일 추가

정상적인 신고처리 상태 10





신고업데이트

해당 신고가 Y나 U로 변경
	Y는 신고승인. U는 신고 미승인, default는 N으로 신고 중인 상태



상태가 Y로 변경되었을 시에

	responseBody에 있는 result 값이 updated이면 그냥 상태 변경이고 BAN이나 BLACKLIST이면 해당 테이블 인스턴스 추가 11

	신고테이블에 있는 신고 카테고리번호가 신고 카테고리 테이블에 존재하지않으면 예외처리 12

	신고된 신고자의 아이디의 인스턴스 중에서 member테이블의 해당 회원의 정지횟수에 대한 컬럼값이
	Report 테이블의 SuspensionCycle이 일치하고, 신고의 카테고리 아이디가 일치하고, 신고상태가 Y인 인스턴스
	의 개수를 확인한다
		그 개수가 10개 이상이거나 해당 신고 카테고리아이디와 일치하는 ReportCategory 테이블에 있는
		countStandard개수와 일치하면 회원 정지 테이블에 해당 회원의 인스턴스가 생성되고 
		Member테이블에 해당 회원의 회원상태가 3으로 변경된다
			13~20
		신고된 신고의 카테고리아이디가 ReportCategory 테이블에 있는 countStandard가 0인 카테고리 아이디는 
		신고승인 즉시 블랙리스트 처리가 되고 Member 테이블에 해당 회원의 상태가 5로 변경된다
			21~24
	Member테이블의 상태변경은 MSA에 의한 회원 서비스를 다른 서버로 분리과정에서 락 발생으로 인해
	Member 테이블에 업데이트 발생 시 @TransactionalEventListener를 사용하여
	이전 트랜잭션이 커밋된 이후 실행할 수 있게 코드변경


신고 정지 event (db서버 event)

매일 자정, enddate가 자정 시간 기준으로 이전이면 member테이블의 상태가 정상인 1로 변경









수정사항 10.13

같은 회원이 신고 못하게
회원신고추가 
크루신고 -> report의 외래키를 member가 아닌 크루멤버로 등록
4번 정지후 result값 blacklist
4번째 정지했을 때 정지테이블에 4번째는 등록되지 않게 
풀리퀘스트 자정 이벤트 ddl 수정
이의신청...
신고 승인됐을때
	크루게시판과 자유게시판 softDelete
	댓글 hardDelete
마지막으로 포스트맨으로 확인 이후 테스트코드작성












10.15 관리자 페이지 (v1.0.0 - 기본 틀만들고 추가하기)

membersourcecode와 기본소스코드에 관리자 페이지용 패키지 추가

백에서 구현된거 위주로 작성
마이페이지에 이의신청 기능
디자인은 프론트 작업 중에 색감이나 틀 조정 예정
헤더, 프터 디자인
완성에 초점을 두고 최대한 심플하게 구상한다음 디테일 잡기
사용할 통계 그래프
	막대그래프, 도넛차트, 라인차트, 히스토그램



회원조회(DB I/O 효율을 위해서 테이블의 컬럼을 3등분해서 가져옴)

	역할별 회원 조회
		localhost:8000/main-client/admin/memberinfo(get방식)
		회원 기본정보 - 기본키, 아이디, 이메일, 이름, 닉네임, 생일, 성별, 회원가입일

SELECT
        id,
        memId,
        email,
        memName,
        nickname,
        birth,
        gender,
        signInDate
        FROM Member
        ORDER BY id DESC
        <if test="limit != null and offset != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>


		localhost:8000/main-client/admin/memberinfostats(get방식)
			전체 회원 수 - 현재 가입된 총 회원 수 - 숫자 카운트(실시간 반영)


			성별 비율 - 현재 가입된 성별에 대한 비율 - 도넛 차트
SELECT
    gender,
    COUNT(*) AS count,
    ROUND(COUNT(*) * 100 / (SELECT COUNT(*) FROM Member), 2) AS ratio
FROM Member
GROUP BY gender;

			연령별 회원 분포 - 10대 이하, 20대, 30대, 40대, 50대, 60대 이상 - 막대그래프
SELECT
    CASE
        WHEN FLOOR(TIMESTAMPDIFF(MONTH, birth, CURDATE()) / 12) <= 10 THEN '10대 이하'
        WHEN FLOOR(TIMESTAMPDIFF(MONTH, birth, CURDATE()) / 12) BETWEEN 11 AND 19 THEN '10대'
        WHEN FLOOR(TIMESTAMPDIFF(MONTH, birth, CURDATE()) / 12) BETWEEN 20 AND 29 THEN '20대'
        WHEN FLOOR(TIMESTAMPDIFF(MONTH, birth, CURDATE()) / 12) BETWEEN 30 AND 39 THEN '30대'
        WHEN FLOOR(TIMESTAMPDIFF(MONTH, birth, CURDATE()) / 12) BETWEEN 40 AND 49 THEN '40대'
        WHEN FLOOR(TIMESTAMPDIFF(MONTH, birth, CURDATE()) / 12) BETWEEN 50 AND 59 THEN '50대'
		  ELSE '60대 이상'
    END AS age_group,
    COUNT(*) AS count
FROM Member
GROUP BY age_group
ORDER BY age_group;

			신규 가입 추이 - 최근 1년간 월별 신규 가입자 수 - 라인차트
SELECT
    YEAR(signInDate) AS year,
    MONTH(signInDate) AS month,
    COUNT(*) AS new_members
FROM
    Member
GROUP BY
    YEAR(signInDate),
    MONTH(signInDate)
ORDER BY
    YEAR(signInDate),
    MONTH(signInDate);


			
		회원 로그인정보 - 기본키, 마지막 로그인, 계정 탈퇴일시, 
				로그인 제한 시간 , 연속 로그인 실패횟수 , 회원 상태(MemberStatus 테이블 조인)


			로그인한 회원 수 지표 - 막대차트
				최근 7일간 로그인한 회원 수
					전체 회원 중 몇 %가 최근 7일 내에 로그인을 했는지
				최근 30일간 로그인한 회원 수
					전체 회원 중 몇 %가 최근 30일 내에 로그인을 했는지
				재방문율 / 충성도 지표
					7일 로그인 회원 수 / 30일 로그인 회원 수 * 100
					주간 활동성이 한 달 대비 얼마나 유지되는지

			시간대별 로그인 분포 - 라인차트
				가로 - 해당 로그인 인스턴스 수
				세로 - 오전 5시부터 오전 9시, 오후 9시부터 오후 12시
					, 오후 12시부터 오후 4시, 오후 12시부터 오후 7시

			정상, 휴면, 탈퇴 비율 - 도넛차트

		회원 등급 및 상태 - 기본키, 등산횟수, 점수(등급 산정 기준), 회원등급 ID, 크루번호

			전체 회원 중 등급별 회원수 
				(15이하, 16이상 49이하, 50이상 99이하, 100이상 179이하, 180이상 399이하, 400이상)
			전체 회원 중 등급별 평균점수
			전체 회원 중 등급별 평균등산횟수
			



신고


	신고
	신고테이블 조회는 하나의 겟방식으로만 가져오고 각 게시판에 맞는 컬럼을 부여한다
	클릭시 해당 인스턴스에 맞는 신고사유와 조인된 게시판테이블의 제목과 내용을 가져온다
	
		자유게시판
			페이지네이션이 처리되어서 10개씩 인스턴스 불러오도록 로직처리
			해당 인스턴스 클릭 시 
				색깔이 짙어지고 기본키가 백으로 넘어간다
				상태를 변경해주는 수락과 거절 버튼이 보인다
				해당 인스턴스 기본키가 백으로 넘어간다
			신고테이블과 해당 게시글이 있는 테이블을 조인하여
				신고테이블의 신고사유와 게시글제목과 게시글 내용을 불러온다
			수락이나 거절을 누르면 확인을 위한 모달창이 나오고 클릭하면 상태를 변경한다
		크루게시판
		댓글
		회원

	이의신청

		이의신청 테이블 전체 조회(get방식 - )
			
		해당 이의신청 조회
			클릭 시 해당 인스턴스에 맞는 이의신청 사유와 해당 신고ID에 신고테이블과 그에 맞는 게시판테이블에서 게시
			글 제목과 게시글 내용을 가져온다(3중 조인)

		이의신청 수락이나 거절 시 상태변경(patch방식 - localhost:8000/main-client/protest/{id})
			수락 시 관리자 id가 등록되고 이의신청 테이블의 상태가 Y로 변경되고 해당 신고테이블이 상태가 N으로 변경



	회원정지

		회원정지 테이블 전체 조회(get방식)

		해당 회원정지 인스턴스의 회원 조회(get방식) ***** 블랙리스트쪽 조회와 동일
			클릭 시 해당 인스턴스에 맞는 회원ID의 회원 테이블에서 이름, 크루ID, 등산횟수, 점수를 가져온다
			해당 인스턴스에 맞는 회원ID의 회원테이블에서 신고를 받은 숫자를 카운트한다

		해당 회원정지 확인 
			해당 인스턴스의 회원정지 테이블에 주석과 관리자 ID insert


	블랙리스트

		블랙리스트 테이블 전체 조회

		해당 블랙리스트 인스턴스의 회원 조회(get방식) ***** 회원정지쪽 조회와 동일
			클릭 시 해당 인스턴스에 맞는 회원ID의 회원 테이블에서 이름, 크루ID, 등산횟수, 점수를 가져온다
			해당 인스턴스에 맞는 회원ID의 회원테이블에서 신고를 받은 숫자를 카운트한다

		해당 블랙리스트 확인
			해당 인스턴스의 블랙리스트 테이블에 주석과 관리자 ID insert



산 및 코스(통계 자료 7~9)(get방식)

	전체 산 개수
	산 테이블에 등록된 지역별 산 개수(13개)
		서울특별시, 경기도, 강원특별자치도, 전북특별자치도, 인천광역시
		충청북도, 충청남도, 경상북도, 경상남도, 전라북도, 전라남도, 부산광역시, 울산광역시
	등반횟수가 많은 산 top5 - climbRecord에서 공통된 산 식별자가 많은 순위
	해발고도에 따른 등반횟수 비율 (500미만, 500~1000, 1000이상) - 도넛차트


	전체 코스 개수
	전체 코스에 대한 난이도별 코스 비율(쉬움, 보통, 어려움)
	난이도별 평균 고도 상승량
		SELECT frtrlDifficulty, AVG(frtrlHeightGain) FROM Frtrl GROUP BY frtrlDifficulty;
	월별 신규 코스 등록 수	


	전체 산도장 획득 수 - MountainStamp 테이블 인스턴스 개수
	전체 코스도장 획득 수 - CourseStamp 테이블 인스턴스 개수
	전체 산북마크 등록 개수
	전체 코스북마크 등록 개수

	등산시작시간 - 오전 4시부터 오후 12시, 오후 12시부터 저녁 8시 기준에 따른 비율
	등산완료시간 - 오전 4시부터 오후 12시, 오후 12시부터 저녁 8시 기준에 따른 비율





크루
	크루

		전체 크루 수

		이번 달 새로 생성된 크루 수
			GROUP BY DATE_FORMAT(crewCreateDate, '%Y-%m')
			
		활동 중인 크루 수
			SELECT COUNT(*) FROM Crew WHERE crewIsDeleted = 'N';

		모집 중인 크루 수
			SELECT COUNT(*) FROM Crew WHERE crewIsRecruit = 'Y';

		등산을 많이한 크루 순위 top5
			크루, 크루 등산 모집 게시판, 크루 등산 기록 3중 조인을 해서 크루 등산 기록 완료 여부 확인
			의 개수를 계산
			
			

	크루 디테일(get 방식)

		전체 크루구성원 수

		현재 활동 중인 크루구성원 수
			SELECT COUNT(*) FROM CrewMembeHistory WHERE crewMemberHistoryState = "JOINED";
		전체 회원 중 크루 소속 수

		전체 회원 중 크루 미소속 수

		전체 등반 게시글 수
			SELECT COUNT(*) FROM CrewClimbBoard;
		전체 크루가입신청 히스토리 수

		전체 크루구성원 히스토리 수



		크루 가입, 탈퇴, 강퇴 비율
			CrewMemberHistory 상태 통계

		크루 등반 성공률
			COUNT(crewClimbHistoryIsSucceed='Y') / COUNT(*) * 100  -- CrewClimbRecord 기준



		
		

	등반 활동 통계
		총 등반 게시글 수
			SELECT COUNT(*) FROM CrewClimbBoard;
		등반 성공률
			COUNT(crewClimbHistoryIsSucceed='Y') / COUNT(*) * 100  -- CrewClimbRecord 기준


전체 구현 후에 일반 관리자 목록 추가예정
정책 페이지 추가
더미데이터 추가 및 수정


10.17
주말에 할일
	피그마 관리자 페이지 신고 마무리
		마이페이지에 신고받은 목록창, 이의신청 페이지 만들기
	백엔드 회원신고 이의신청 만들기
	html, css 사용해서 디자인 만들어놓기
	자바스크립트 기초 14_js 다시 보기
	위치기반을 지도에 띄우는게 가능한가?
	구글 아날리틱스 사용해보기



10.19 백엔드 마지막 정리

------------------------------------------------------------------------------------------------------------
	게시판 쪽 페이지네이션 가져오기
	1. 자유게시판, 크루, 댓글별 조회및 상태 수정
		[변경사항] 미승인이 N으로 되어있고 U가 취소상태인데 변경예정 -- 
		[변경사항] 관리자 승인 시 로그인 된 관리자 ID 신고 테이블에 입력 -- 
	2. 이의신청 조회
		[변경사항] 수락 및 거절로 인한 상태변경 
			1의 화면구현과 거의 유사
		마이페이지에 로그인한 회원의 신고가 수락된 신고 조회 -> 이의 신청 
			-> 이의신청된 신고 이의신청 수락이나 거절
				개인 신고조회, 이의신청 내역
		[변경사항] 이의 신청 확인이 됐는지 확인하는부분
	3. 회원정지 조회(Ban table)
		회원정지 전체조회 
		회원정지 확인을 위해 adminId가 등록되어있지 않으면 확인버튼을 통해 해당 로그인된 관리자 id 등록
		회원정지가 이상하다면 해당 정지 보류 -- 예정
		[변경사항] 회원정지 확인 시 회원정지에 대한 주석 입력 후 확인 입력 시 해당 인스턴스 관리자 ID입력
					벤 테이블에 주석 컬럼 추가
	4. 블랙리스트 조회(Blacklist table)
		블랙리스트 전체조회
		[변경사항] 블랙리스트가 된 회원의 신고내역 조회
		[변경사항] 블랙리스트 확인 시 블랙리스트에 대한 주석 입력 후 확인 입력 시 해당 인스턴스 관리자 ID입력
					블랙리스트 테이블에 주석 컬럼 추가

위 자료는 피그마 작성 때 수정해야 될부분 체크한 것으로 마지막 정리할 때 확인하기

------------------------------------------------------------------------------------------------------------


select
	신고 타입별 조회(reports/type/{type}) - board, crew, coment, member
		
	신고 타입과 승인별 조회
	개인에 대한 신고내역 승인 상태 조회
	정지 전체조회
	블랙리스트 전체조회
	이의신청 전체	

create, update, delete

	회원 신고 추가
	회원 신고 상태변경
	이의신청 추가
		
	이의신청 상태변경
		이의신청 Y로 상태변경시 해당 신고 테이블 이의신청 N으로 상태변경



10월 22일 용어에 대한 고민
	회원 테이블에 있는 컬럼이 많아서 컬럼을 3등분해서 따로가져올까 하는데 전체를 가져오고 뿌리는게 좋을까 
	3등분하는게 좋을까?
		“DB I/O 효율 vs 개발 복잡도” 사이의 트레이드오프 문제

