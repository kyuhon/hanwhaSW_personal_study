렌탈브레인

11.30 주제 선정 및 초기 기획 단계 정리 ----------------------------------------------------------------------


다음주에 해야할 일
	서류 작업 체계화
		프로젝트 개요서
		요구사항 명세서
		msa 도메인 분리 문서
		erd(서비스 간에는 절대 FK연결 금지)
		테이블 정의서
		API 명세서
		이벤트 설계문서
		AWS 아키텍쳐 설계 문서
		CI/CD 파이프라인 설계 문서
		Security 설계 문서
		테스트 전략 문서
		페이지 구조 및 UX Wireframe 문서
	분업
-------------------

질문사항

형석

서진
	캠페인 관리에 왜 전자결제가 들어가야하지?
창훈

순우

지현

--------------------

msa 구조

고객관리, 자산관리, as관리, 캠페인관리, 계약관리 5개의 도메인으로 나누었는데
전부 독립서버로 나누면 서비스가 과도하게 쪼개져서 운영 복잡도와 비용 증가
2개의 백서버와 1개의 게이트웨이 서버를 이용한 단일인점 방식은 이전에 해보았으니 3개의 서버를 운영하는게 운영에 대한 학습적 측면으로 좋아보임




3개의 서버
customer-contract-service
고객/계약/결제/연체

asset-as-service
자산/장비관리/AS/상태 처리

campaign-service
고객 세그먼트/캠페인/마케팅 자동화/알림
발송 로그 저장/ 오픈/클릭 이벤트 수집



전자결제(카드/계좌)
견적서 승인
청구서 발행
연체 관리
수납/정산
계약 상태 변경 이벤트 수신



중개서버가 필요한가???

--------------------

학습

고객 원본 db를 갖고 있으면서 별도로 campaign-service 서버에서 캐시 db를 갖는다



--------------------

승우
주요기능 - 시나리오
	크로스셀링 시나리오
	결합할인유도


지현
스케쥴러??
고객목록 LTV 삭제


가중치
월매출
캠패인현황
고객세그먼트별 평균별 얼만큼 썼나
알림
자산현황
분기별 고객수
고객관리
고객목록
고객응대

ai인사이트


--------------------------------------------

견적부터 계약까지 시나리오
1. 상담 + 문의 (2차 고객 -> 1차 고객 가격 및 제품 문의)
2. 상담추가 (영업팀)
3. 견적서 발송(회사 -> 고객)
4. 계약 페이지 등록
5. 계약 결재 후 고객한테 알림
6. 고객 제품 사용 후 피드백 or 컴플레인
7. 제품 반납

리텐션
프로모션
업셀링
쿠폰


------------------------------------------


12.02

상담 문의 같은 내용들 메모할 수 있는 공간


------------------------------------------

12.03

구글 폼에 대한 채널

설문페이지에 csv파일로 올리고 해당 파일을 토대로 


-------------------------------------------------------------------------


렌탈 브레인 맡은 기능 정리

- 어느정도는 msa구조로 나누어질것을 고려해서 만들자
- 요구사항 명세서 수정하기(12/11 오전중으로)
- JPA vs 트리거
	비즈니스 의미가 있고 여러 서비스에서 공유되면 JPA

1. 현재 기획의 중간 단계(피그마 레이아웃)부터 문제파악하기



***************** 피그마 수정사항 *****************

영업관리 카테고리에서 계약(결제)에 있는 검색창 placeholder에 자산명이 아니라 계약명 수정

신규 계약 등록에 2번째 렌탈 자산이 아닌 렌탈 상품

계약 상세보기에서 계약 개요에 고객정보를 없애고 이름 밑에 고객정보빼고 삭제

***************** 수정사항 *****************
계약 테이블에 현재 승인 단계 추가
	erd수정했지만 아직 더미데이터 수정 x


***************** 수정완료사항 *****************




*****************	계약(결제)와 계약관리 질문사항과 해결방안 *****************

계약 테이블에 계약 상태에 계약진행(P), 계약종료(C)
	결제 대기, 결제 거절 2개의 상태를 추가해야하지 않나?	good

프로모션과 쿠폰이 선택창에 나오는 기준이 어떻게 되지??
	세그먼트 기준

계약 상세보기 -> 결제 내역 -> 결제 추이 그래프가 있어야하나?? 
	피그마 프론트는 기본적으로 고객 목록 상세보기를 그대로 가져와서
	수정사항 많음

결제 테이블에 요청일과 결제일은 무슨 기능이지?
	결제테이블과 비식별관계로 결제내역 테이블이 있어야 월별 결제를 넣을수 있을듯

신규 계약 등록 -> 결제에서 결제선 지정은 어떤 방식으로 등록되는거지??



*************************************************************************************
*****************	계약(결제)와 계약관리 작업 시에 공통 사항 *****************

페이지네이션 및 필터 처리 -> 실제 데이터 조회, 전체 데이터 개수 조회
ex)
SELECT *
FROM item
WHERE name LIKE '%프린터%'
ORDER BY created_at DESC
LIMIT 20 OFFSET 0;

SELECT COUNT(*)
FROM item
WHERE name LIKE '%프린터%';


신규 계약 등록 시에 redis사용은 2차나 3차로




계약(결제) 페이지 *****************

	직원이 현재 회사에서 렌탈 계약된 명세를 확인할 수 있다
		계약진행(P), 만료임박(D), 계약만료(C) 상태 전체조회
	1차고객(기업)에서 계약한 전체내역과 로그인한 사용자가 승인이나 반려한 계약 내역을 볼 수 있다
	계약 테이블에 상태 컬럼에 계약진행(P),만료임박(D),계약만료(C),결제대기(W),결제거절(R)
		위 컬럼값에서 계약 진행과 계약 종료 그리고 만료 임박에 따른 필터 
		
	결제 프로세스
	1. 처음 계약이 생성되면 결제대기생성(W)
	1-1. 결제 승인자 매핑 테이블에 1,2,3 create
	1-2. 기안자는 결제 진행 중에 승인
	2. 중간에 계약이 반려되면 W ->결제거절업데이트(R)
	3. 계약이 최종결제가 승인되면 W -> 결제진행(P)
	4. 계약 만료 3개월 전에는 P -> 만료임박(D)
	5. 계약 만료 시 D -> 계약만료(D)
	

	/contract/status - get method
		진행 중 계약
			상태가 진행중인 계약 / 전체 계약 수 count
		만료임박
			계약 종료일이 현재 날짜기준에서 30일 이내일 때
		만료 예정
			계약 종료일이 현재 날짜기준에서 30일 초과 60일 이내일 때
		신규 계약
			계약 시작일부터 30일 기간이 지나지 않을 때

	/contract/list - get method
		contract테이블에 컬럼이 status인 컬럼값 P,D,C 전체조회
			customer테이블 조인(cum_id) 후 in_charge 컬럼값 불러오기
		페이지네이션, 필터 처리
			검색대상 - 계약ID, 기업명, 담당자, 계약명
			필터(상태) - 진행중, 만료임박, 만료
		계약 ID는 CT-1 이런식으로 ??

	/contract/list/{id} - get method
		로그인한 사용자가 승인이나 반려한 계약내역 조회
		결제 요청자(기안자) + 결제 승인자
			결제 승인자는 어떻게 조회하지??


계약 상세보기 *****************


	공통
		/contractdetail/{id} - get method
			계약진행률, 시작일, 마감일, 계약 종료까지 남은 일수
			납부완료, 총 납부액, 렌탈 자산, as처리 건수, 연체 이력

	계약 개요 - 계약, 고객, 제품
			기본 계약 정보(특약사항 포함), 결제 조건, 계약한 제품내역
		
	결제 내역 - 계약
			정상납부 퍼센트, 총납부 완료액, 다음 납부 예정일
			
	타임라인 - 계약, 고객, 제품
			계약에 대한 생애주기 
				계약이 시작되고부터 완료되기 까지 상태 변경에 대한 이력 조회
				ex) 계약시작, 정기납부, 추가렌탈, as처리
					이름, 내용, 해당날짜, 상태에 따른 이미지(프론트에서 처리)
	
	계약수정
		수정할 데이터 ??


신규 계약 등록 *****************


해당 고객을 클릭하고 다음을 누르면 redis에 임시저장 -> ttl 시간 설정해주기 x
			클라이언트에 임시저장

	고객선택
		고객테이블에 아이디, 이름, 담당자, 번호 
		그리고 세그먼트 아이디를 토대로 조인한 세그먼트 이름 조회
		블랙리스트 제외하고 고객목록 select
		순우
		customer 테이블 id, customer_code, name, in_charge , 
				segement_id와 동일한 segment 테이블에 id에서 name컬럼
		블랙리스트(segment테이블 id 6번) 제외하고 is_deleted가 N인 인스턴스 
		name과 in_charge 검색 가능하고 페이지네이션 포함
		
		
	계약 정보 및 렌탈 상품
		계약명 작성 후 제품 테이블에 대여가능 상태인 상품 조회 및 자산 추가
		해당 고객의 상태에 따른 프로모션 선택 ??
		
	결제 조건
		이전 정보를 토대로 월 납부액 및 계약 총액 계산
		결제방법, 결제일(계약 시작일 default), 특약사항
		해당 고객의 상태에 따른 쿠폰 선택 ??

		특약사항 글자수 제한 넣기(650자)
		emp_position
			1 대표, 2 고객관리팀장, 3 영업관리팀장, 4 제품관리팀장, 5 팀원
		 

	결제
		전자결제 현황, 결제선 지정

	검토 및 제출
		클라이언트에 저장된 내역 조회
		승인 요청 시 각각의 테이블에 create

	/contract - post method
		계약명, 계약 시작일, 계약기간, 월 납부액, 계약 총액, 결제 방법(자동이체(A), 계좌이체(B)), 특약사항, 고객목록 번호
		사원 ID(팀원), 사원ID(팀장), 사원ID(대표)
		
		자동생성 - 계약 코드(클래스 파일), 계약상태(결제대기(W)), 현재승인단계(팀원 승인:1)
		계약 인스턴스 1개, 결제 인스턴스 1개, 결제 승인자 매핑 인스턴스 3개 생성

		
		CREATE TABLE contract (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  contract_code VARCHAR(30) NOT NULL UNIQUE, -- CON-2025-001
  name VARCHAR(255) NOT NULL,
  start_date DATETIME NOT NULL,
  contract_period INTEGER NOT NULL,
  status VARCHAR(1) NOT NULL,
  monthly_payment INTEGER NULL,
  total_amount BIGINT NOT NULL,
  pay_method VARCHAR(1) NOT NULL,
  special_content VARCHAR(2000) NULL,
  current_step TINYINT NOT NULL,
  cum_id BIGINT UNSIGNED NOT NULL,
  PRIMARY KEY (id)
);

CREATE TABLE approval (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  approval_code VARCHAR(30) NOT NULL UNIQUE, -- APP-2025-001
  title VARCHAR(255) NOT NULL,
  content VARCHAR(2000) NOT NULL,
  request_date DATETIME NOT NULL,
  approval_date DATETIME NOT NULL,
  status VARCHAR(1) NOT NULL,
  contract_id BIGINT UNSIGNED NOT NULL,
  emp_id BIGINT UNSIGNED NOT NULL,
  PRIMARY KEY (id)
);

CREATE TABLE approval_mapping (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  emp_id BIGINT UNSIGNED NOT NULL,
  approval_id BIGINT UNSIGNED NOT NULL,
  step INTEGER NULL,
  is_approved VARCHAR(1) NULL,
  reject_reason VARCHAR(255) NULL,
  PRIMARY KEY (id)
);

계약인증 *****************



결제관리 *****************

	대기
		현재 로그인된 직원과 직급에 대해서 권한받은 결제선의 목록이 나오고 승인이나 반려할수 있음
		현재 결제내역이 나오지만 이전 내역이 승인되지 않으면 클릭이 안되고
			 이전 결제가 완료되어야 진행할 수 있습니다
		라는 문구가 나옴

	진행
		현재 로그인된 직원과 직급에 대해서 권한받은 렌탈계약이 반려되지 않고 결제가 진행중인 내역이 나옴
		본인이 승인한 렌탈계약이 반려되지 않고 결제가 진행중인 내역

	완료
		현재 로그인된 직원과 직급에 대해서 권한받은 렌탈계약이 반려되거나 렌탈 계약이 진행중인 내역이 나옴
		본인이 승인한 렌탈계약이 반려되거나 결제가 완료된 내역






마무리 *****************
코드 정리 단계



api명세서 **********************************

***계약***

/contract/list
get method
계약 전체 조회
	페이지네이션과 필터 구현


/contract/status
get method
	진행중 계약, 만료임박, 신규계약


/contract/detail/{id}
get method
계약 상세보기
	상세계약상태

	상세계약개요

	상세계약렌탈자산


/contract
post method






***결제***


/approval/status
get method

결제 대기 건수, 진행중 건수, 결제 완료 건수, 반려 건수0


/approval/request
get method

사용자의 결제가 필요한 내역


/approval/process
get method

사용자의 결제가 진행된 내역


/approval/complete
get method

사용자의 결제가 완료된 내역


/approval
patch method

사용자의 결제가 필요한 내역에 대한 승인이나 반려(상태변경)

***************** 다른 패키지에서 사용해야할 api


/api/customer/contract
get method

계약시에 고객 목록 저장
customer 테이블 id, customer_code, name, in_charge , 
segement_id와 동일한 segment 테이블에 id에서 name컬럼
      
블랙리스트(segment테이블 id 6번) 제외하고 is_deleted가 N인 인스턴스 
      
name과 in_charge 검색 가능하고 페이지네이션 포함



/item/contract
get method
상태가 렌탈가능한 상태인 제품목록과 렌탈가능 재고량


고객의 세그먼트에 대한 프로모션 조회

해당 프로모션 사용 시 이력등록

고객의 세그먼트에 대한 쿠폰 조회

해당 쿠폰 사용 시 이력등록



***************************************************
