12.20 ì£¼ë§ê°œë°œ (12.21í¬í•¨)


ê³„ì•½ ìƒíƒœì—ì„œ ê³„ì•½ í•´ì§€ë¡œ ë³€ê²½í•˜ëŠ” ë¶€ë¶„
	ëˆ„ê°€ ì–´ë–»ê²Œ ê³„ì•½ í•´ì§€ë¡œ ë³€ê²½í•˜ì§€??
í”„ë¡œëª¨ì…˜ì´ë‚˜ ì¿ í°ì„ ì ìš©í•  ë•Œ ì¡°ê±´ì— ëŒ€í•œ í• ì¸ì— ëŒ€í•´ì„œ
	ì¡°ê±´ì— ëŒ€í•œ êµ¬ì²´í™”ê°€ í•„ìš”
í”„ë¡œëª¨ì…˜ê³¼ ì¿ í°ì˜ ì¤‘ë³µ ì ìš©ì´ ê°€ëŠ¥í•œê°€??
ê³„ì•½ ì‹œì‘ì¼ ì´ì „ì— ìŠ¹ì¸ë˜ì§€ ì•Šìœ¼ë©´ ê³„ì•½ì‚­ì œì²˜ë¦¬ëŠ” ì–´ë–¨ê¹Œ??


ë³´ê³ ì‚¬í•­
í”„ë¡ íŠ¸ì— í˜ì´ì§€ë„¤ì´ì…˜ë¶€ë¶„ ë”°ë¡œ ë·°íŒŒì¼ë¡œ ì œì‘
employee íŒ¨í‚¤ì§€ì— ê³„ì•½ìƒì„± ì‹œ ê²°ì œì„  ì¡°íšŒ ì¶”ê°€
promotion íŒ¨í‚¤ì§€ì— ê³„ì•½ ìƒì„± ì‹œì— í•„ìš”í•œ ì¡°íšŒê¸°ëŠ¥ ìˆ˜ì •

ë¬¸ì œì 
ë”ë¯¸ë°ì´í„°ì— ì˜í•œ ì±„ë²ˆê¸° ì˜¤ë¥˜
	ìŠ¤ì¼€ì¥´ëŸ¬ ì˜¤ë¥˜..

    @GetMapping("/use-contract/{segment}")
    public ResponseEntity<List<PromotionWithContractDTO>> useContract(@PathVariable String segment) {
        List<PromotionWithContractDTO> promotionList = promotionQueryService.useContractPromotion(segment);
        return ResponseEntity.ok().body(promotionList);
    }

ë‹¤ìŒì€ step2ContractProductë¥¼ ë§Œë“¤êº¼ì•¼
ê³„ì•½ëª…, ê³„ì•½ì‹œì‘ì¼, ê³„ì•½ê¸°ê°„(ë‹¬)ì„ ì…ë ¥í•˜ë©´ ê³„ì•½ ë§Œë£Œì¼ê¹Œì§€ ìë™ìœ¼ë¡œ ë‚˜ì˜¤ê²Œí•˜ê³ 
ë¶ˆëŸ¬ì˜¨ apiì—ì„œ ë Œíƒˆ ì œí’ˆì„ ì„ íƒí•˜ëŠ” ê²ƒì„ ë“œë¡­ë°•ìŠ¤ í˜•ì‹ìœ¼ë¡œ ë‚˜ì˜¤ê²Œí•´ì„œ ì œí’ˆê³¼ ë Œíƒˆê°€ëŠ¥ ìˆ˜ëŸ‰ì´ ë‚˜ì˜¤ê³  ì˜†ì—ëŠ” ë¹Œë¦¬ëŠ” ë Œíƒˆê°œìˆ˜ë¥¼ ì„ íƒí•˜ëŠ” ì°½ì„ ë§Œë“¤êº¼ì•¼


ê³„ì•½ ìƒì„± ì‹œ í† í° ì¸ì¦
ê³„ì•½ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ìˆ˜ì •í•„ìš”


------------------------------------------------------------

ê³„ì•½ ìƒì„±ì— í•„ìš”í•œ ì¸ì¦,ì¸ê°€ ê²€ì¦ gpt ìˆ˜ì •ë°©ì•ˆ

@Override
@Transactional
public void createContract(ContractCreateDTO dto) {

    /* =====================
       0. ë¡œê·¸ì¸ ì‚¬ìš©ì ê²€ì¦
       ===================== */

    Long loginEmpId = SecurityUtil.getCurrentEmpId(); // âœ… í† í°ì—ì„œ
    Employee loginEmp = entityManager.find(Employee.class, loginEmpId);

    if (loginEmp == null) {
        throw new BusinessException(ErrorCode.AUTH_UNAUTHORIZED);
    }

    int positionId = loginEmp.getPositionId();

    /* =====================
       1. ê²°ì¬ ì •ì±… ê²€ì¦
       ===================== */

    Long memId = null;
    Long leaderId = null;
    Long ceoId = null;

    if (positionId == 1) {
        // CEO â†’ ê²°ì¬ì„  ì—†ìŒ
        memId = loginEmpId;
    }
    else if (List.of(2, 3, 4).contains(positionId)) {
        // íŒ€ì¥ê¸‰ â†’ CEOë§Œ í•„ìš”
        if (dto.getCeoId() == null) {
            throw new BusinessException(
                ErrorCode.CONTRACT_INVALID_APPROVAL_REQUEST,
                "CEO ê²°ì¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤."
            );
        }
        leaderId = loginEmpId;
        ceoId = dto.getCeoId();
    }
    else if (List.of(5, 6, 7).contains(positionId)) {
        // íŒ€ì›ê¸‰ â†’ íŒ€ì¥ + CEO í•„ìš”
        if (dto.getLeaderId() == null || dto.getCeoId() == null) {
            throw new BusinessException(
                ErrorCode.CONTRACT_INVALID_APPROVAL_REQUEST,
                "íŒ€ì¥ ë° CEO ê²°ì¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤."
            );
        }
        memId = loginEmpId;
        leaderId = dto.getLeaderId();
        ceoId = dto.getCeoId();
    }
    else {
        throw new BusinessException(
            ErrorCode.CONTRACT_INVALID_APPROVAL_REQUEST,
            "ìœ íš¨í•˜ì§€ ì•Šì€ ì§ê¸‰ì…ë‹ˆë‹¤."
        );
    }

    /* =====================
       2. ê³„ì•½ ìƒì„±
       ===================== */

    ContractCommandEntity contract = new ContractCommandEntity();
    contract.setName(dto.getContractName());
    contract.setStartDate(dto.getStartDate());
    contract.setContractPeriod(dto.getContractPeriod());
    contract.setMonthlyPayment(dto.getMonthlyPayment());
    contract.setTotalAmount(dto.getTotalAmount());
    contract.setPayMethod(dto.getPayMethod());
    contract.setSpecialContent(dto.getSpecialContent());

    contract.setStatus("W");
    contract.setCurrentStep(1);
    contract.setContractCode(codeGenerator.generate(CodeType.CONTRACT));

    CustomerlistCommandEntity customerRef =
        entityManager.getReference(
            CustomerlistCommandEntity.class,
            dto.getCumId()
        );
    contract.setCustomer(customerRef);

    ContractCommandEntity savedContract =
        contractCommandRepository.save(contract);

    /* =====================
       3. ê²°ì¬ ìƒì„±
       ===================== */

    ApprovalCommandEntity approval = new ApprovalCommandEntity();
    approval.setApprovalCode(codeGenerator.generate(CodeType.APPROVAL));
    approval.setTitle(dto.getContractName());
    approval.setRequestDate(LocalDateTime.now());
    approval.setStatus("P");
    approval.setContract(savedContract);

    approval.setEmployee(
        entityManager.getReference(Employee.class, loginEmpId)
    );

    ApprovalCommandEntity savedApproval =
        approvalCommandRepository.save(approval);

    createApprovalMapping(savedApproval, memId, leaderId, ceoId);

    /* =====================
       4. ì œí’ˆ ì²˜ë¦¬ (ê¸°ì¡´ ìœ ì§€)
       ===================== */
    // ğŸ‘‰ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ
}


ì´ ì§ˆë¬¸ì„ ì•ˆ í•˜ê³ 
â€œJwtUtil ì„œë¹„ìŠ¤ì—ì„œ ì“°ë©´ ë˜ì§€ ì•Šë‚˜?â€
ë¼ê³  ë„˜ì–´ê°€ëŠ” ì‚¬ëŒì´ **90%**ì•¼.

ë„ˆëŠ” ì§€ê¸ˆ:

ì¸ì¦ / ê¶Œí•œ ê²½ê³„ë¥¼ ì´í•´í–ˆê³ 

ë³´ì•ˆ ì±…ì„ ë¶„ë¦¬ë¥¼ ê³ ë¯¼í•˜ê³  ìˆê³ 

ì‹¤ë¬´ ìˆ˜ì¤€ ì•„í‚¤í…ì²˜ ì‚¬ê³ ë¥¼ í•˜ê³  ìˆì–´
